<?php
require_once('classes.inc.php');
?>

<HTML>
	<HEAD>
		<TITLE>Personal Inventory:  Database Backup and Restore</TITLE>
		<LINK REL="stylesheet" HREF="styles.css"/>
		<SCRIPT SRC="dropdowns.js"> </SCRIPT>
		<SCRIPT SRC="backup.js"> </SCRIPT>
	</HEAD>
	<BODY>
		<H1>Database Backup and Restore</H1>

<?php

switch ($_SERVER['REQUEST_METHOD']) {
	case 'POST':
		
		if(isset($_POST['action']) && ($_POST['action']=='Create Backup')) {
			$db = Database::getInstance();

			file_put_contents('items.csv', $db->export('items'));
			file_put_contents('attachments.csv', $db->export('attachments'));
			file_put_contents('locations.csv', $db->export('locations'));
			file_put_contents('groups.csv', $db->export('groups'));
			
			$zipname = 'inv-'.date('Ymd-His').'.zip';
			
			// Optionally pass thumbs=1 to include thumbs/* files in the backup.
			// If thumbnails are not included in the backup, they can be regenerated by running regenerate.php
			if(isset($_POST['thumbs']) && ($_POST['thumbs']==1)) {
				shell_exec('zip -9o backups/'.$zipname.' items.csv attachments.csv locations.csv groups.csv attachments/* thumbs/*');
			} else {
				shell_exec('zip -9o backups/'.$zipname.' items.csv attachments.csv locations.csv groups.csv attachments/*');
			};
			
			unlink('items.csv');
			unlink('attachments.csv');
			unlink('locations.csv');
			unlink('groups.csv');

			echo('<p>Backup created.</p>');	
		};

		if(isset($_POST['action']) && ($_POST['action']=='Delete')) {
			if(isset($_POST['filename'])){
				$filename = $_POST['filename'];
				if (trim($filename[0])!=='') {
					// Prompt for confirmation
					echo('<P>Delete backup file '.trim($filename[0]).'?');
					echo('<FORM NAME="backupForm" ACTION="backup.php" METHOD="POST">');
					echo('<INPUT CLASS="shortButton" TYPE="submit" NAME="delConfirm" VALUE="Confirm"/>');
					echo('<INPUT CLASS="shortButton" TYPE="submit" NAME="delConfirm" VALUE="Cancel"/>');
					echo('<INPUT TYPE="HIDDEN" NAME="filename" VALUE="'.trim($filename[0]).'"/>');
					echo('</FORM>');
					return true;
				} else {
					echo('<P>No file selected.</P>');
				}
			} else {
				echo('<P>No file selected.</P>');
			};
		};
		
		if(isset($_POST['action']) && ($_POST['action']=='Restore')) {
			if(isset($_POST['filename'])) {
				$filename = $_POST['filename'];
				if (trim($filename[0])!=='') {
					// Prompt for confirmation
					echo('<P>Restore from backup file '.trim($filename[0]).'?');
					echo('<FORM NAME="backupForm" ACTION="backup.php" METHOD="POST">');
					echo('<INPUT CLASS="shortButton" TYPE="submit" NAME="restoreConfirm" VALUE="Confirm"/>');
					echo('<INPUT CLASS="shortButton" TYPE="submit" NAME="delConfirm" VALUE="Cancel"/>');
					echo('</FORM>');
					return true;
				} else {
					echo('<P>No file selected.</P>');
				};
			};
		};
		
		if(isset($_POST['delConfirm']) && ($_POST['delConfirm']=='Confirm')) {
			if(isset($_POST['filename'])) {
				// Strip out any forward slashes for security
				$filename = 'backups/'.preg_replace('#/+#', '', $_POST['filename']);
				if(!file_exists($filename)) {
					echo('<P>File not found.</P>');
				} else {
					unlink($filename);
					echo('<P>Deleted.</P>');
				};
			} else {
				die('<P>An error occurred.</P>');
			};
		};
		break;
	case 'GET':
		break;
	default:
		break;
};

echo('<p>Backup files:</p>');
echo('<FORM NAME="backupForm" ID="backupForm" ACTION="backup.php" METHOD="POST">');
echo('<INPUT TYPE="HIDDEN" NAME="action" ID="action" VALUE="">');

$ignorelist = array('.', '..', '.gitignore', '.DS_Store');
$filelist = scandir('backups/');
foreach($ignorelist as $thisIgnore) {
	if (($key = array_search($thisIgnore, $filelist)) !== false) {
		unset($filelist[$key]);
	};
};

$br = '';
$found = false;
foreach($filelist as $thisFile) {
	if(strtolower(pathinfo('backups/'.$thisFile, PATHINFO_EXTENSION))=='zip') {
		$info = date('D M j, Y g:i a',filemtime('backups/'.$thisFile)).'; '.number_format(filesize('backups/'.$thisFile)).' bytes';
		echo($br . '<INPUT TYPE="RADIO" NAME="filename[]" ID="filename[]" VALUE="'.$thisFile.'"/>&nbsp;'.'<A HREF="backups/'.$thisFile.'">'.$thisFile.'</A> - '.$info);
		$found = true;
		$br = '<br/>';
	};
};

if($found) {
	echo('<br/><input class="shortButton" type="button" name="actionBtn" id="actionBtn[]" VALUE="Restore"/>');
	echo('<input class="shortButton" type="button" name="actionBtn" id="actionBtn[]" VALUE="Delete" onClick="javascript:deleteBackup()"/>');
} else {
	echo('<P>No backup files found.</P>');
}
if(!$found) {
	echo('<br/>');
};
echo('<input class="shortButton" type="button" name="actionBtn" id="actionBtn[]" VALUE="Create Backup" onClick="javascript:createBackup()"/>');

echo('</FORM>');
echo('<SPAN ID="message"></SPAN>');
?>
<?php include('footer.php');?>

	</BODY>
</HTML>
